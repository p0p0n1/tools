<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>大乱闘ログビューア</title>
<style>
* {
    box-sizing: border-box;
}
html {
 font-family: sans-serif;
 width: 100%;
 height: 100%;
}
body {
 margin:  0;
 padding: 0;
 width: 100%;
 height: 100%;
 background: #eeeeee;
}
.main {
 height: 100%;
 padding: 10px;
 background: gray;
}
.usrinf {
 border: 2px solid white;
 border-radius: 7px;
 display: inline-block;
 width: 35%;
 color: white;
 padding: 5px;
 margin: 5px;
 background: black;
 max-width: 240px;
 font-size: 18px;
 box-shadow: 1px 1px 3px 0 black;
}
.xanim {
 animation: xx 200ms;
}
@keyframes xx {
 0% {
 transform: translateX(0px);
 }
 20% {
 transform: translateX(-5px);
 }
40% {
 transform: translateX(5px);
 }
60% {
 transform: translateX(3px);
 }
80% {
 transform: translateX(-3px);
 }
100% {
 transform: translateX(0px);
 }
}
.message {
 font-size: 18px;
 border-radius: 7px;
 border: 2px solid white;
 background: black;
 padding: 5px;
 margin: 3px
 width: 90%;
 color: white;
 max-width: 600px;
 box-shadow: 1px 1px 3px 0 black;
}
#ta {
 background: #eeeeee;
 width: 90%;
 height: 5em;
}
.btn {
    display: block;
	border: 1px solid #333333;
    background: linear-gradient(#eeeeee, #888888);
    box-shadow: 1px 1px 3px 0 gray;
    border-radius: 99px;
    width: 50%;
    padding: 10px;
    margin: 5px auto;
    font-size: 18px;
}
.btn:active {
    background: lightgray;
    color: black;
}
</style>
</head>
<body>
<div class="main">
<textarea id="ta" placeholder="ここに大乱闘ログを貼付け、開始を。黒窓を押せば進みます。名前にさん、さんさんが含まれているとバグります多分。"></textarea>
<br>
<button class="btn" type="button" onclick="btl()">開始</button><br>
<div id="usr1" class="usrinf" onclick="next()">
テスト
</div>
<div id="usr2" class="usrinf" onclick="next()">
テスト
</div>
<div id="mes" class="message" onclick="next()">
テスト
</div>
</div>
<script>
let ta;
let usr1;
let usr2;
let mes;
let name1;
let name2;
let logar;
let turn = -1;
getLog();
async function getLog() {
	let p = getparam();
	if(p === "") {
		return;
	}
	let r = await fetch(p,{
		mode:"cors"
	});
	let log = await r.text();
	document.getElementById("ta").value = log;
}
function btl() {
	ta = document.getElementById("ta");
	usr1 = document.getElementById("usr1");
	usr2 = document.getElementById("usr2");
	usr1.classList.remove("xanim");
	usr2.classList.remove("xanim");
	usr1.addEventListener("animationend", () => {
		usr1.classList.remove("xanim");
	});
	usr2.addEventListener("animationend", () => {
		usr2.classList.remove("xanim");
	});
	mes = document.getElementById("mes");
	const t = ta.value.replace(/\r\n?/, '\n');
	logar = t.split('\n');
	turn = 0;
	let pt = /([^\[]+)\[HP:(\d+)\][^、]+、\s*([^\[]+)\[HP:(\d+)\][^。]+。/;
	let r = logar[0].match(pt);
	let hp1;
	let hp2;
	if (r) {
		name1 = r[1];
		hp1 = r[2];
		name2 = r[3];
		hp2 = r[4];
		usr1.innerHTML = name1 + "<br>HP: " + hp1;
		usr2.innerHTML = name2 + "<br>HP: " + hp2;
		mes.innerHTML = logar[0];
	}
}

function next() {
	if(turn < 0) return;
	turn++;
	if (turn == logar.length) {
		btl();
	}
	let line = logar[turn];
	let winpt = /(.+)が勝った！/;
	rwin = line.match(winpt);
	if (rwin) {
		mes.innerHTML = line;
		return;
	}
	let m = line.split("<>");
	if (m.length < 2) {
		if (line.length !== 0) {
			mes.innerHTML = line.replace(/ターン\d+:/, "");
		}
		return;
	}
	let pt1 = /ターン\d+: (.+)さん\[.+\].+/;
	let pt2 = /(.+)さんさん.+\[HP:([+-]?\d+)\].+/;
	let r1 = m[0].match(pt1);
	let r2 = m[1].match(pt2);
	if ((r1 != null) && (r2 != null)) {
		if (r1[1] == name1) {
			if (r2[1] == name2) {
				usr2.classList.remove("xanim");
				usr2.classList.add("xanim");
				hp2 = r2[2];
				usr2.innerHTML = name2 + "<br>HP: " + hp2;
				mes.innerHTML = m[0].replace(/ターン\d+:/, "").replace(/さん/g, "") + "<br>" + m[1].replace("さんさん", "");
			}
		}
		if (r1[1] == name2) {
			if (r2[1] == name1) {
				usr1.classList.remove("xanim");
				usr1.classList.add("xanim");
				hp1 = r2[2];
				usr1.innerHTML = name1 + "<br>HP: " + hp1;
				mes.innerHTML = m[0].replace(/ターン\d+:/, "").replace(/さん/g, "") + "<br>" + m[1].replace("さんさん", "");
			}
		}
	} else {
		if (line.length !== 0) {
			mes.innerHTML = line;
		}
	}
}
function getparam() {
	var s = window.location.search;
	var pat = /\?[^=]+=(.+)/;
	if(pat.test(s)) {
		const param = s.match(pat);
		if(param[1]) {
			return param[1];
		} else {
			return "";
		}
	}
	return "";
}
</script>
</body>
</html>
